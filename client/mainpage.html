<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" title="custstyle" href="assets/css/custstyle.css"/>
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/icons/fontawesome/css/style.css">
  <link rel="stylesheet" href="assets/css/slick.css">
  <link rel="stylesheet" href="assets/css/animate.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <script src="https://unpkg.com/vue"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <title>to do fancy</title>
</head>
<body class="cont-mainpage">

  <div id="app">
    <load @out="logout"></load>
    <todo @new="newTask" :todos="todos"></todo>
  </div>

  <!-- start template component -->
  <template id="loader-template">
    <div>
      <!-- start loader -->
      <div class="loader-wrapper">
        <div class="loader">
          <svg class="circular" viewBox="25 25 50 50">
            <circle class="loader-animation" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10" />
          </svg>
        </div>
      </div>
      <!-- end loader-->
      <!-- START HEADER -->
      <header class="no-bg">
        <div class="container">
          <div class="row">
            <div class="col-md-4">
              <div class="navbar-header pull-left">
                <!-- Logo -->
                <a class="navbar-brand" href="index.html"><img src="#" class="img-responsive" alt=""/></a>
              </div>
            </div>
      
            <div class="col-md-8">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-2">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            
              <!-- MENU -->
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2">
                <ul class="nav navbar-nav navbar-right">
                  <li><a @click="toLogOut" >logout</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </header>
    <!-- END HEADER -->
    </div>
  </template>
  

  <template id="todolist-template">
    <div class="col-md-6 offset-md-3 mainTODO">
      <div>
        <form @submit.prevent="toNewTodo">
            <input type="text" v-model="newTodo" style="color: black;">
            <input type="submit" value="add" style="color: black;">
        </form>
      </div>
      <div style="margin-top:3%;">
        <ul v-if="!todos.length">
            <li > note: Belum ada task</li>
        </ul>
        <ul v-for="(todo, index) in todos" :key="index">
          <li >
            <span v-bind:class="{'completed' : todo.completed}">
              <span style="color:white;">{{ index+1 }}. {{ todo.title }}</span>
            </span>
            <button v-on:click="toDelete(todo, index)" style="margin-left:8%; color: black;">x</button>
            <button v-on:click="toggleCompleted(todo)" style="color: black;">done</button>
          </li>
        </ul>
      </div>
    </div>
  </template>
  <!-- end template component -->

</body>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
<script>
  // start component
  Vue.component('load', {
    template : '#loader-template',
    methods : {
      toLogOut(){
        this.$emit('out')
      }
    }
  })
  Vue.component('todo',{
    template : '#todolist-template',
    props : ['todos'],
    data : function(){
      return{
        username : localStorage.getItem('name'),
        newTodo : ''
      }
    },
    methods : {
      toNewTodo(){
        let inputTask = this.newTodo.trim()
        if(inputTask){
          this.$emit('new', {
            title : this.newTodo,
            author : localStorage.getItem('user_Id'),
            completed : false,
            id_date : Date.now()
          })
          this.newTodo = ''
        }
      },
      toDelete(todo, index){
        this.todos.splice(index, 1)
        console.log(todo._id)
        if(!todo._id){
          axios.post('http://localhost:3000/api/tasks/todelete', todo)
          .then(response => {
            console.log(response)
          })
          .catch(function(err){
            console.log(err)
          })
        }else{
          axios.delete('http://localhost:3000/api/tasks/'+ todo._id)
          .then(response => {
            console.log(response)
          })
          .catch(function(err){
            console.log(err)
          })
        } 
      },
      toggleCompleted : function (todo) {
        todo.completed = !todo.completed
        // console.log(todo._id)
        if(!todo._id){
          // console.log(todo.completed)
          axios.post('http://localhost:3000/api/tasks/update', todo)
          .then(response => {
            console.log(response)
          })
          .catch(function(err){
            console.log(err)
          })
        }else{
          axios.put('http://localhost:3000/api/tasks/'+ todo._id, {
            completed : !todo.completed
          })
          .then(response => {
            console.log(response)
          })
          .catch(function(err){
            console.log(err)
          })
        }
      }
    }
  })
  // end component
  new Vue({
    el : '#app',
    data : {
      todos : [],
      done : false
    },
    created(){
      // console.log('<<<', localStorage.getItem('user_Id'))
      // start cek condition storage
      let storage = localStorage.getItem('token')
      if (storage === null) {
        window.location = "http://localhost:8080/login.html"
      }
      // end cek condition storage
      // load data by user
      axios.get('http://localhost:3000/api/tasks')
      .then(({data}) => {
        let user = localStorage.getItem('user_Id')
        let dataUser = data
        dataUser.forEach(data => {
          if(data.author._id === user){
            console.log(data)
            this.todos.push(data)
          }
        })
      })
      .catch(function(err){
        console.log(err)
      })
    },
    methods : {
      newTask : function(addNewTask){
        console.log(addNewTask)
        this.todos.push(addNewTask)
        // console.log(this.todos[0].title)
        axios.post('http://localhost:3000/api/tasks', addNewTask)
        .then(function(response){
          console.log(response)
        })
        .catch(function(err){
          console.log(err)
        })
      },
      logout : function(){
        localStorage.removeItem('token')
        localStorage.removeItem('name')
        localStorage.removeItem('user_Id')
        window.location = "http://localhost:8080/login.html"
      }
    }
  })
</script>
<script src="assets/js/loader.js"></script>
<script src="assets/js/jquery.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/slick/slick.min.js"></script>
<script src="assets/js/jquery.easing.min.js"></script>
</html>